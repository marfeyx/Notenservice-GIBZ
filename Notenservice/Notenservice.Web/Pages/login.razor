@page "/Login"
<section>
    <h1 class="text-center m-3">Login</h1>

    <div class="container-fluid row justify-content-center">
        <div class="card col-4">
            <div class="m-3 row justify-content-center">
                <input class="col-12 m-3 mb-0 card p-2" placeholder="Username" @bind="Username" />
                <input class="col-12 m-3 mb-0 card p-2" placeholder="Password" @bind="Password" />
                <button class="col-6 m-3 mb-0 btn btn-primary"
                        type="button" @onclick="LoginAsync">
                    Login
                </button>
                <a class="col-6 mt-2" href="/Register">Nicht registriert? Hier registrieren</a>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <p class="error-text" style="color:#b91c1c">@error</p>
    }
</section>

@code {
    string Username = "";
    string Password = "";
    string? error;

    private async Task LoginAsync()
    {
        error = null;

        try
        {
            var result = await AuthService.LoginAsync(new UserLoginRequestDTO
            {
                Username = Username.Trim(),
                Password = Password
            });

            if (result is not null && !string.IsNullOrWhiteSpace(result.Token))
            {
                await JS.InvokeVoidAsync("localStorage.setItem", "authToken", result.Token);
                if (AuthStateProvider is CustomAuthStateProvider custom)
                {
                    await custom.MarkUserAsAuthenticated(result.Token);
                }

                Http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", result.Token);

                Nav.NavigateTo("/shop");
            }
            else
            {
                error = "Invalid login.";
            }
        }
        catch (Exception ex)
        {
            error = "Login failed: " + ex.Message;
        }
    }
}

