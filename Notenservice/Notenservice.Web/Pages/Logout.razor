@page "/logout"
@inject HttpClient Http
@inject NavigationManager Nav
@inject CustomAuthStateProvider AuthStateProvider

@* fix naming *@
<PageTitle>Logout</PageTitle>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<style>
    :root {
        --primary-color: #1976d2;
        --primary-dark: #0d47a1;
        --gradient-start: #e3f2fd;
        --gradient-mid: #bbdefb;
    }

    .page-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-mid) 50%, var(--gradient-start) 100%);
    }

    nav.light-blue {
        box-shadow: none;
    }

    .auth-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px 16px;
    }

    .auth-layout {
        width: 100%;
        max-width: 1100px;
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: stretch;
    }

    .auth-card {
        background: #ffffff;
        border-radius: 20px;
        padding: 40px 32px;
        box-shadow: 0 25px 70px rgba(25, 118, 210, 0.18);
        flex: 1 1 360px;
    }

    .card-header-icon {
        display: flex;
        justify-content: center;
        margin-bottom: 12px;
    }

    .card-header-icon .material-icons {
        font-size: 56px;
    }

    .auth-card h2 {
        margin: 8px 0 10px;
        text-align: center;
        color: var(--primary-dark);
        font-weight: 600;
    }

    .auth-card p.lead {
        text-align: center;
        color: #546e7a;
        margin-bottom: 28px;
    }

    .info-panel {
        flex: 1 1 280px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .info-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 20px 50px rgba(13, 71, 161, 0.14);
    }

    .info-card h4 {
        margin: 10px 0 6px;
        color: var(--primary-dark);
        font-weight: 600;
    }

    .info-card p {
        margin: 0;
        color: #5f6368;
        line-height: 1.5;
    }

    .info-card i.material-icons {
        font-size: 40px;
        margin-bottom: 8px;
        color: var(--primary-color);
    }

    .full-width {
        width: 100%;
    }

    .btn-flat.full-width {
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        font-weight: 600;
        color: var(--primary-dark);
    }

    .feedback {
        margin-top: 18px;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 600;
    }

    .feedback-error {
        background: #ffebee;
        color: #c62828;
    }

    .feedback-success {
        background: #e8f5e9;
        color: #2e7d32;
    }
</style>

<div class="page-shell">
    <nav class="light-blue darken-2">
        <div class="nav-wrapper">
            <a href="/homepage" class="brand-logo" style="margin-left:15px;">
                <img src="../Images/GIBZLogo.png" alt="GIBZ Logo" style="height:50px;" />
            </a>
        </div>
    </nav>

    <section class="auth-wrapper">
        <div class="auth-layout">
            <div class="auth-card z-depth-3">
                <div class="card-header-icon">
                    <i class="material-icons large blue-text text-darken-2">logout</i>
                </div>
                <h2>Logout</h2>
                <p class="lead">Beende deine Sitzung sicher und schütze sensible Daten.</p>

                <button class="btn waves-effect waves-light blue darken-2 full-width"
                        @onclick="LogoutAsync"
                        disabled="@_isProcessing">
                    @(_isProcessing ? "Wird abgemeldet..." : "Jetzt abmelden")
                </button>

                <a class="btn-flat full-width" href="/homepage">
                    Zurück zur Homepage
                </a>

                @if (!string.IsNullOrWhiteSpace(_statusMessage))
                {
                    <div class="@_statusCssClass" role="status">@_statusMessage</div>
                }
            </div>

            <aside class="info-panel">
                <div class="info-card">
                    <i class="material-icons">shield</i>
                    <h4>Schutz deiner Daten</h4>
                    <p>Tokens werden entfernt und die Sitzung sofort invalidiert.</p>
                </div>
                <div class="info-card">
                    <i class="material-icons">insights</i>
                    <h4>Nachvollziehbarkeit</h4>
                    <p>Immer klar ersichtlich, wer zuletzt angemeldet war.</p>
                </div>
                <div class="info-card">
                    <i class="material-icons">tips_and_updates</i>
                    <h4>Best Practices</h4>
                    <p>Regelmäßiges Abmelden erhöht die Sicherheit der Plattform.</p>
                </div>
            </aside>
        </div>
    </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        M.AutoInit();
    });
</script>

@code {
    private bool _isProcessing;
    private string? _statusMessage;
    private string _statusCssClass = "feedback feedback-success";

    private async Task LogoutAsync()
    {
        if (_isProcessing)
        {
            return;
        }

        _isProcessing = true;
        _statusMessage = null;

        try
        {
            await AuthStateProvider.MarkUserAsLoggedOut();
            Http.DefaultRequestHeaders.Authorization = null;

            _statusCssClass = "feedback feedback-success";
            _statusMessage = "Du bist abgemeldet. Einen Moment, wir bringen dich zurück zum Login.";

            await Task.Delay(1500);
            Nav.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            _statusCssClass = "feedback feedback-error";
            _statusMessage = $"Logout fehlgeschlagen: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
